<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桌面端大屏幕适配测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { border-left: 4px solid #28a745; }
        .info { border-left: 4px solid #17a2b8; }
        .warning { border-left: 4px solid #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .size-display {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-weight: bold;
        }
        .layout-preview {
            display: flex;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .panel-preview {
            background: #e9ecef;
            padding: 20px;
            width: 350px;
            height: 600px;
        }
        .canvas-preview {
            background: #f8f9fa;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .canvas-square {
            background: #dee2e6;
            border: 2px solid #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>桌面端大屏幕适配测试</h1>
    
    <div class="test-container">
        <h2>当前窗口信息</h2>
        <div id="window-info" class="test-result info">
            <div>窗口尺寸: <span id="window-size"></span></div>
            <div>设备类型: <span id="device-type"></span></div>
            <div>布局模式: <span id="layout-mode"></span></div>
        </div>
    </div>

    <div class="test-container">
        <h2>桌面端适配测试</h2>
        <div id="desktop-results" class="test-result success"></div>
    </div>

    <div class="test-container">
        <h2>布局预览</h2>
        <div id="layout-preview" class="layout-preview">
            <!-- 动态生成的布局预览 -->
        </div>
    </div>

    <div class="test-container">
        <h2>实时测试</h2>
        <p>调整浏览器窗口大小来测试响应式适配：</p>
        <button onclick="updateTests()">刷新测试</button>
        <button onclick="simulateDesktop()">模拟标准桌面</button>
        <button onclick="simulateUltraWide()">模拟超宽屏</button>
        <button onclick="simulateLargeScreen()">模拟大屏幕</button>
        <div id="realtime-results" class="test-result info"></div>
    </div>

    <script>
        // 模拟适配参数常量
        const DESKTOP_ADAPTATION = {
            TOP_BOTTOM_MARGIN: 40,
            LEFT_RIGHT_MARGIN: 20,
            CANVAS_PANEL_GAP: 10,
            PANEL_WIDTH: 350,
            MIN_PANEL_WIDTH: 280,
            MIN_CANVAS_SIZE: 320,
            MAX_CANVAS_SIZE: 2560,
            MIN_HEIGHT_THRESHOLD: 560,
        };

        const DEVICE_THRESHOLDS = {
            DESKTOP_MIN_WIDTH: 1024,
            TABLET_MIN_WIDTH: 640,
            PHONE_MAX_WIDTH: 639,
            DESKTOP_MOBILE_HEIGHT: 560,
        };

        // 计算桌面端画布尺寸
        function calculateDesktopCanvasSize(windowWidth, windowHeight) {
            const { TOP_BOTTOM_MARGIN, LEFT_RIGHT_MARGIN, CANVAS_PANEL_GAP, PANEL_WIDTH, MIN_CANVAS_SIZE, MAX_CANVAS_SIZE } = DESKTOP_ADAPTATION;
            
            // 定义最小安全边距
            const MIN_SAFE_MARGIN = 30;
            
            // 计算可用高度
            const availableHeight = windowHeight - TOP_BOTTOM_MARGIN * 2;
            
            // 计算可用宽度
            const safeLeftRightMargin = Math.max(LEFT_RIGHT_MARGIN, MIN_SAFE_MARGIN);
            const availableWidth = windowWidth - safeLeftRightMargin * 2 - PANEL_WIDTH - CANVAS_PANEL_GAP;
            
            // 画布尺寸取两者的最小值
            let canvasSize = Math.min(availableHeight, availableWidth);
            
            // 应用最小值和最大值限制
            canvasSize = Math.max(MIN_CANVAS_SIZE, Math.min(canvasSize, MAX_CANVAS_SIZE));
            
            // 计算实际需要的左右边距
            const contentWidth = PANEL_WIDTH + CANVAS_PANEL_GAP + canvasSize;
            const requiredTotalWidth = contentWidth + MIN_SAFE_MARGIN * 2;
            
            let actualLeftRightMargin = MIN_SAFE_MARGIN;
            if (windowWidth > requiredTotalWidth) {
                actualLeftRightMargin = Math.max(MIN_SAFE_MARGIN, (windowWidth - contentWidth) / 2);
            }
            
            return {
                canvasSize,
                panelHeight: canvasSize,
                actualPanelWidth: PANEL_WIDTH,
                actualLeftRightMargin,
                debug: {
                    availableHeight,
                    availableWidth,
                    contentWidth,
                    requiredTotalWidth,
                    safeLeftRightMargin,
                    minSafeMargin: MIN_SAFE_MARGIN,
                    isHeightLimited: availableHeight <= availableWidth,
                    isWidthLimited: availableWidth < availableHeight,
                    adaptationStrategy: windowWidth > requiredTotalWidth ? '居中模式' : '安全边距模式',
                }
            };
        }

        // 设备类型和布局模式检测
        function getDeviceLayoutMode(windowWidth, windowHeight) {
            const { DESKTOP_MIN_WIDTH, TABLET_MIN_WIDTH, DESKTOP_MOBILE_HEIGHT } = DEVICE_THRESHOLDS;
            
            // 计算宽高比，用于识别移动设备的长条形屏幕
            const aspectRatio = Math.max(windowWidth, windowHeight) / Math.min(windowWidth, windowHeight);
            
            // 长宽比大于1.8通常是手机屏幕，但超宽屏桌面显示器也可能有较大的宽高比
            // 因此，我们需要额外检查屏幕尺寸，排除大屏幕显示器
            const isLongScreen = aspectRatio > 1.8 && windowWidth < 2000;
            
            // 检测是否是桌面大屏幕 - 更强的检测逻辑，支持超宽屏
            const isLargeDesktopScreen = (windowWidth >= 1920 && windowHeight >= 900) || // 标准大屏幕
                                        (windowWidth >= 2560 && windowHeight >= 800) || // 超宽屏
                                        (windowWidth >= 3000); // 任何超过3000px宽的屏幕都视为桌面
            
            // 强制桌面模式的条件
            const forceDesktop = isLargeDesktopScreen || 
                                (windowWidth >= 1600 && windowHeight >= 800) || // 宽屏桌面
                                (windowWidth * windowHeight >= 2500000); // 总像素数超过250万的大屏幕
            
            // 高分辨率移动设备检测
            const isHighResolutionMobile = isLongScreen && (
                (windowWidth > 1000 && windowHeight > 2000) || // 竖屏高分辨率手机
                (windowHeight > 1000 && windowWidth > 2000)    // 横屏高分辨率手机
            );
            
            // 强制移动端判断条件 - 排除桌面大屏幕
            const forceMobile = (windowHeight < DESKTOP_MOBILE_HEIGHT || isHighResolutionMobile) && !forceDesktop;
            
            // 强制桌面模式优先判断
            if (forceDesktop) {
                return {
                    deviceType: 'desktop',
                    layoutMode: 'desktop',
                    forceReason: 'large_screen'
                };
            }
            
            if (forceMobile) {
                return {
                    deviceType: 'phone',
                    layoutMode: windowWidth > windowHeight ? 'landscape' : 'portrait',
                    forceReason: isHighResolutionMobile ? 'high_resolution_mobile' : 'height_threshold'
                };
            }
            
            if (windowWidth >= DESKTOP_MIN_WIDTH && (!isLongScreen || windowWidth >= 2000)) {
                return {
                    deviceType: 'desktop',
                    layoutMode: 'desktop',
                };
            } else if (windowWidth >= TABLET_MIN_WIDTH && (!isLongScreen || windowWidth >= 1200)) {
                return {
                    deviceType: 'tablet',
                    layoutMode: 'desktop',
                };
            } else {
                return {
                    deviceType: 'phone',
                    layoutMode: windowWidth > windowHeight ? 'landscape' : 'portrait',
                };
            }
        }

        // 更新窗口信息
        function updateWindowInfo() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const deviceInfo = getDeviceLayoutMode(width, height);
            
            document.getElementById('window-size').textContent = `${width} × ${height}`;
            document.getElementById('device-type').textContent = deviceInfo.deviceType;
            document.getElementById('layout-mode').textContent = deviceInfo.layoutMode + (deviceInfo.forceReason ? ` (${deviceInfo.forceReason})` : '');
        }

        // 更新测试结果
        function updateTests() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // 桌面端测试
            const desktopResult = calculateDesktopCanvasSize(width, height);
            const deviceInfo = getDeviceLayoutMode(width, height);
            
            let debugInfo = '';
            if (desktopResult.debug) {
                const d = desktopResult.debug;
                debugInfo = `
                    <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px;">
                        <div><strong>调试信息:</strong></div>
                        <div>基于高度的尺寸: <span class="size-display">${d.heightBasedSize || d.availableHeight}px</span></div>
                        <div>基于宽度的尺寸: <span class="size-display">${d.widthBasedSize || d.availableWidth}px</span></div>
                        <div>是否受高度限制: <span class="size-display">${d.isHeightLimited ? '是' : '否'}</span></div>
                        <div>是否受宽度限制: <span class="size-display">${d.isWidthLimited ? '是' : '否'}</span></div>
                        <div>宽高比: <span class="size-display">${(width / height).toFixed(2)}</span></div>
                        <div>适配策略: <span class="size-display">${d.adaptationStrategy || (d.isHeightLimited ? '高度优先' : '宽度限制')}</span></div>
                    </div>
                `;
            }
            
            document.getElementById('desktop-results').innerHTML = `
                <div><strong>桌面端计算结果:</strong></div>
                <div>画布尺寸: <span class="size-display">${desktopResult.canvasSize}px</span></div>
                <div>面板高度: <span class="size-display">${desktopResult.panelHeight}px</span></div>
                <div>面板宽度: <span class="size-display">${desktopResult.actualPanelWidth}px</span></div>
                <div>左右边距: <span class="size-display">${desktopResult.actualLeftRightMargin.toFixed(1)}px</span></div>
                <div>可用宽度: <span class="size-display">${desktopResult.debug ? desktopResult.debug.availableWidth : 'N/A'}px</span></div>
                <div>可用高度: <span class="size-display">${desktopResult.debug ? desktopResult.debug.availableHeight : 'N/A'}px</span></div>
                ${debugInfo}
            `;
            
            // 更新布局预览
            updateLayoutPreview(desktopResult, deviceInfo);
            
            // 实时结果
            document.getElementById('realtime-results').innerHTML = `
                <div><strong>当前适配结果 (${deviceInfo.deviceType} - ${deviceInfo.layoutMode}):</strong></div>
                <div>推荐画布尺寸: <span class="size-display">${desktopResult.canvasSize}px</span></div>
                <div>窗口尺寸: <span class="size-display">${width} × ${height}</span></div>
                <div>适配比例: <span class="size-display">${(desktopResult.canvasSize / Math.min(width, height) * 100).toFixed(1)}%</span></div>
            `;
            
            updateWindowInfo();
        }
        
        // 更新布局预览
        function updateLayoutPreview(result, deviceInfo) {
            const preview = document.getElementById('layout-preview');
            preview.innerHTML = '';
            
            if (deviceInfo.deviceType === 'desktop' || deviceInfo.deviceType === 'tablet') {
                // 桌面布局预览
                const panelPreview = document.createElement('div');
                panelPreview.className = 'panel-preview';
                panelPreview.innerHTML = `<h3>控制面板</h3><p>宽度: ${result.actualPanelWidth}px</p><p>高度: ${result.panelHeight}px</p>`;
                
                const canvasPreview = document.createElement('div');
                canvasPreview.className = 'canvas-preview';
                
                const canvasSquare = document.createElement('div');
                canvasSquare.className = 'canvas-square';
                canvasSquare.style.width = `${result.canvasSize}px`;
                canvasSquare.style.height = `${result.canvasSize}px`;
                canvasSquare.textContent = `${result.canvasSize} × ${result.canvasSize}`;
                
                canvasPreview.appendChild(canvasSquare);
                
                preview.appendChild(panelPreview);
                preview.appendChild(canvasPreview);
            } else {
                // 移动端布局预览
                preview.innerHTML = '<div style="padding: 20px; text-align: center;">移动端布局 - 请使用移动端测试工具</div>';
            }
        }

        // 模拟标准桌面尺寸
        function simulateDesktop() {
            const sizes = [
                { width: 1366, height: 768 },
                { width: 1920, height: 1080 },
                { width: 1440, height: 900 }
            ];
            
            let message = '标准桌面尺寸测试:\n\n';
            sizes.forEach(size => {
                const result = calculateDesktopCanvasSize(size.width, size.height);
                const deviceInfo = getDeviceLayoutMode(size.width, size.height);
                message += `${size.width}×${size.height}: 画布=${result.canvasSize}px, 设备=${deviceInfo.deviceType}, 布局=${deviceInfo.layoutMode}\n`;
            });
            
            alert(message);
        }

        // 模拟超宽屏尺寸
        function simulateUltraWide() {
            const sizes = [
                { width: 2560, height: 1080 },
                { width: 3440, height: 1440 },
                { width: 5120, height: 1440 }
            ];
            
            let message = '超宽屏尺寸测试:\n\n';
            sizes.forEach(size => {
                const result = calculateDesktopCanvasSize(size.width, size.height);
                const deviceInfo = getDeviceLayoutMode(size.width, size.height);
                message += `${size.width}×${size.height}: 画布=${result.canvasSize}px, 设备=${deviceInfo.deviceType}, 布局=${deviceInfo.layoutMode}\n`;
            });
            
            alert(message);
        }

        // 模拟大屏幕尺寸
        function simulateLargeScreen() {
            const sizes = [
                { width: 2170, height: 1080 }, // 问题边界值
                { width: 2171, height: 1080 }, // 问题边界值+1
                { width: 2560, height: 1440 }, // 常见4K显示器
                { width: 3360, height: 1802 }, // 用户报告的问题尺寸
                { width: 3440, height: 1440 }, // 超宽屏显示器
                { width: 5120, height: 1440 }  // 超超宽屏显示器
            ];
            
            let message = '大屏幕尺寸测试:\n\n';
            sizes.forEach(size => {
                const result = calculateDesktopCanvasSize(size.width, size.height);
                const deviceInfo = getDeviceLayoutMode(size.width, size.height);
                message += `${size.width}×${size.height}: 画布=${result.canvasSize}px, 设备=${deviceInfo.deviceType}, 布局=${deviceInfo.layoutMode}`;
                if (deviceInfo.forceReason) {
                    message += ` (${deviceInfo.forceReason})`;
                }
                message += '\n';
            });
            
            alert(message);
        }

        // 初始化和事件监听
        window.addEventListener('load', updateTests);
        window.addEventListener('resize', updateTests);
        
        // 定期更新（用于测试）
        setInterval(updateTests, 1000);
    </script>
</body>
</html>