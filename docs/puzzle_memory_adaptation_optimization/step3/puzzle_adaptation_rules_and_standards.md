# 拼图块适配规则与标准

## 📋 核心适配规则

### 1. 基准状态规则 (Base State Rule)
**规则**: 始终以原始拼图块状态（basePuzzle）作为适配基准
- **触发时机**: 生成拼图时自动保存原始状态
- **保存内容**: 完整的拼图块坐标、形状、属性信息
- **使用场景**: 所有后续的窗口调整适配

```typescript
// 规则实现
dispatch({ type: "SET_BASE_PUZZLE", payload: pieces });
```

### 2. 绝对坐标适配规则 (Absolute Coordinate Rule)
**规则**: 每次适配都从原始状态重新计算，避免累积误差
- **计算方式**: 基于原始画布尺寸和当前画布尺寸的比例关系
- **变换基准**: 画布中心点作为统一变换基准
- **误差控制**: 杜绝基于当前状态的相对变换

```typescript
// 规则实现
const adaptedPieces = adaptPuzzlePiecesAbsolute(
  state.basePuzzle,           // 原始状态
  originalCanvasSize,         // 原始尺寸
  currentCanvasSize          // 当前尺寸
);
```

### 3. 画布中心基准规则 (Canvas Center Reference Rule)
**规则**: 所有变换以画布中心为基准点
- **原始中心**: `(originalWidth/2, originalHeight/2)`
- **当前中心**: `(currentWidth/2, currentHeight/2)`
- **变换公式**: `newPoint = currentCenter + (originalPoint - originalCenter) * scale`

### 4. 最小边长缩放规则 (Min Edge Scaling Rule)
**规则**: 基于画布最小边长计算缩放比例，保持形状比例
- **缩放计算**: `scale = currentMinEdge / originalMinEdge`
- **边长定义**: `minEdge = Math.min(width, height)`
- **比例保持**: 确保拼图块不会因画布比例变化而变形

### 5. 状态检测规则 (State Detection Rule)
**规则**: 智能检测拼图块状态，只对符合条件的拼图块执行适配
- **适配条件**:
  - 存在拼图块 (`state.puzzle && state.puzzle.length > 0`)
  - 拼图块未散开 (`!state.isScattered`)
  - 存在目标形状 (`shapeToAdapt && shapeToAdapt.length > 0`)
  - 存在原始状态 (`state.basePuzzle`)

```typescript
// 规则实现
const shouldAdaptPuzzlePieces = (
  state.puzzle && 
  state.puzzle.length > 0 && 
  !state.isScattered && 
  shapeToAdapt && 
  shapeToAdapt.length > 0
);
```

## 📏 适配标准

### 1. 精度标准 (Precision Standards)
- **位置精度**: 像素级精确对齐（误差 < 1px）
- **缩放精度**: 保持3位小数精度的缩放比例
- **角度精度**: 保持原始旋转角度不变

### 2. 性能标准 (Performance Standards)
- **响应时间**: 适配计算 < 100ms
- **内存使用**: 不产生内存泄漏
- **并发处理**: 支持快速连续的窗口调整操作

### 3. 兼容性标准 (Compatibility Standards)
- **设备兼容**: 桌面端和移动端统一适配逻辑
- **浏览器兼容**: 支持主流浏览器的画布API
- **分辨率兼容**: 支持各种屏幕分辨率和DPI

### 4. 稳定性标准 (Stability Standards)
- **状态一致性**: 适配前后拼图块数量保持不变
- **形状保持**: 拼图块的相对形状和大小关系不变
- **中心对齐**: 拼图整体始终保持画布居中

## 🔄 适配流程标准

### 阶段1: 状态检测
1. 检查basePuzzle是否存在
2. 验证拼图块未散开状态
3. 确认目标形状有效性

### 阶段2: 参数计算
1. 计算原始画布中心点
2. 计算当前画布中心点
3. 计算基于最小边长的缩放比例

### 阶段3: 坐标变换
1. 将原始坐标转换为相对于中心的坐标
2. 应用缩放变换
3. 转换回绝对坐标系统

### 阶段4: 状态更新
1. 更新拼图块坐标
2. 保持其他属性不变
3. 触发重新渲染

## 🎯 质量保证标准

### 1. 测试覆盖标准
- **单元测试**: 覆盖所有适配函数
- **集成测试**: 验证与游戏系统的集成
- **E2E测试**: 模拟真实用户操作场景

### 2. 错误处理标准
- **输入验证**: 检查所有输入参数的有效性
- **异常捕获**: 捕获并处理所有可能的异常
- **回退机制**: 适配失败时的安全回退策略

### 3. 调试支持标准
- **日志记录**: 详细的适配过程日志
- **状态暴露**: 提供测试和调试接口
- **性能监控**: 记录适配性能指标

## 📊 验收标准

### 功能验收
- ✅ 拼图块与目标形状完美重叠
- ✅ 多次窗口调整后位置仍然准确
- ✅ 不同设备和分辨率下表现一致

### 性能验收
- ✅ 适配响应时间 < 100ms
- ✅ 内存使用稳定，无泄漏
- ✅ 支持快速连续操作

### 稳定性验收
- ✅ 长期使用无异常
- ✅ 极端画布尺寸下正常工作
- ✅ 与其他系统功能无冲突

---

## 🔧 实施指南

### 开发者指南
1. **遵循绝对坐标原则**: 永远基于原始状态计算
2. **使用画布中心基准**: 确保变换的一致性
3. **实施状态检测**: 避免不必要的适配操作
4. **添加详细日志**: 便于问题诊断和性能优化

### 测试指南
1. **验证基准状态**: 确保basePuzzle正确设置
2. **测试多次调整**: 验证累积误差控制
3. **检查边界条件**: 测试极端画布尺寸
4. **验证性能指标**: 确保适配性能达标

---

*适配规则和标准 v1.0*  
*制定日期: 2025年1月22日*  
*适用范围: Step3拼图块适配系统*