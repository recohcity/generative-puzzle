# 碰撞与回弹配置

> 修订日期：2025-01-24 (v1.3.36)

本文档详细说明碰撞检测与回弹系统的配置参数，包括边界检测、回弹效果、碰撞音效、震动动画等核心配置。

---

## 1. 边界检测配置

### bounceBackFactor
- **作用**：控制拼图块碰撞边界后的回弹强度
- **取值范围**：0.1~0.6
- **默认值**：0.4
- **影响点**：回弹距离、视觉效果
- **配置/代码位置**：`contexts/GameContext.tsx`

### maxBounceDistance
- **作用**：回弹距离上限
- **取值范围**：30~80（像素）
- **默认值**：60像素
- **影响点**：回弹效果的视觉强度
- **配置/代码位置**：`contexts/GameContext.tsx`

### collisionThreshold
- **作用**：边界检测的精度阈值
- **取值范围**：0.05~0.2（像素）
- **默认值**：0.1像素
- **影响点**：碰撞检测灵敏度、性能
- **配置/代码位置**：`contexts/GameContext.tsx`

### boundaryDetectionMethod
- **作用**：边界检测方法配置
- **检测方法**：
  - 'boundingBox'：边界框检测（快速）
  - 'centerPoint'：中心点检测（简单）
  - 'precise'：精确多边形检测（准确）
- **默认值**：'boundingBox'
- **影响点**：检测精度和性能平衡
- **配置/代码位置**：`contexts/GameContext.tsx`（边界检测逻辑）

---

## 2. 回弹效果配置

### bounceAnimation
- **作用**：回弹动画配置
- **动画参数**：
  - 持续时间：300ms
  - 缓动函数：ease-out
  - 回弹曲线：弹性曲线
- **默认值**：启用回弹动画
- **影响点**：回弹的视觉效果
- **配置/代码位置**：`contexts/GameContext.tsx`（回弹动画逻辑）

### bounceDirection
- **作用**：回弹方向计算配置
- **计算方法**：
  - 垂直边界：水平回弹
  - 水平边界：垂直回弹
  - 角落碰撞：对角回弹
- **默认值**：自动计算回弹方向
- **影响点**：回弹方向的准确性
- **配置/代码位置**：`contexts/GameContext.tsx`（方向计算）

### bounceDecay
- **作用**：回弹衰减配置
- **衰减策略**：
  - 线性衰减：匀速减弱
  - 指数衰减：快速减弱
  - 弹性衰减：振荡减弱
- **默认值**：指数衰减
- **影响点**：回弹效果的自然程度
- **配置/代码位置**：`contexts/GameContext.tsx`（衰减计算）

### multipleCollisionHandling
- **作用**：多重碰撞处理配置
- **处理策略**：
  - 同时碰撞多个边界的处理
  - 连续碰撞的防抖处理
  - 碰撞优先级排序
- **默认值**：启用多重碰撞处理
- **影响点**：复杂碰撞场景的稳定性
- **配置/代码位置**：`contexts/GameContext.tsx`（多重碰撞逻辑）

---

## 3. 碰撞音效配置

### collisionSound
- **作用**：边界碰撞音效（双音调）
- **音频参数**：
  - 低音：120Hz，持续0.15s
  - 高音：240Hz，持续0.1s
  - 波形：正弦波
  - 音量：0.2
- **默认值**：如上所示
- **影响点**：碰撞的听觉反馈
- **配置/代码位置**：`contexts/GameContext.tsx`（音效触发）、`utils/rendering/soundEffects.ts`（音效实现）

### soundTriggerConditions
- **作用**：音效触发条件配置
- **触发条件**：
  - 碰撞强度超过阈值
  - 音效间隔时间限制
  - 全局音效开关状态
- **阈值设置**：
  - 最小碰撞强度：0.3
  - 音效间隔：100ms
- **默认值**：启用条件触发
- **影响点**：音效播放的合理性
- **配置/代码位置**：`contexts/GameContext.tsx`（触发条件）

### soundVariation
- **作用**：音效变化配置
- **变化策略**：
  - 根据碰撞强度调整音量
  - 根据碰撞位置调整音调
  - 随机化音效参数
- **默认值**：启用音效变化
- **影响点**：音效的丰富性和真实感
- **配置/代码位置**：`utils/rendering/soundEffects.ts`（音效变化逻辑）

---

## 4. 震动动画配置

### shakeAnimation
- **作用**：边界碰撞震动动画配置
- **震动参数**：
  - 震动次数：4~8次
  - 震动幅度：[8, -6, 5, -4, 3, -2]像素
  - 震动间隔：30ms
  - 总持续时间：180ms
- **默认值**：6次震动，间隔30ms
- **影响点**：碰撞的视觉反馈强度
- **配置/代码位置**：`hooks/usePuzzleInteractions.ts`（震动动画逻辑）

### shakeIntensity
- **作用**：震动强度配置
- **强度等级**：
  - 轻微：幅度±3px，3次震动
  - 中等：幅度±6px，6次震动
  - 强烈：幅度±10px，8次震动
- **强度选择**：根据碰撞强度自动选择
- **默认值**：中等强度
- **影响点**：震动效果的视觉冲击力
- **配置/代码位置**：`hooks/usePuzzleInteractions.ts`（强度计算）

### shakeDirection
- **作用**：震动方向配置
- **方向策略**：
  - 水平震动：左右摆动
  - 垂直震动：上下摆动
  - 随机震动：多方向组合
- **默认值**：根据碰撞方向自动选择
- **影响点**：震动效果的方向感
- **配置/代码位置**：`hooks/usePuzzleInteractions.ts`（方向计算）

### shakeEasing
- **作用**：震动缓动配置
- **缓动函数**：
  - 线性：匀速震动
  - 衰减：逐渐减弱
  - 弹性：弹性震动
- **默认值**：衰减缓动
- **影响点**：震动效果的自然程度
- **配置/代码位置**：`hooks/usePuzzleInteractions.ts`（缓动实现）

---

## 5. 碰撞检测优化配置

### collisionDetectionOptimization
- **作用**：碰撞检测性能优化配置
- **优化策略**：
  - 空间分区加速检测
  - 粗检测+精检测两阶段
  - 缓存检测结果
- **性能目标**：
  - 检测时间：< 5ms
  - CPU占用：< 10%
  - 内存使用：< 5MB
- **默认值**：启用所有优化
- **影响点**：碰撞检测的性能表现
- **配置/代码位置**：`contexts/GameContext.tsx`（优化逻辑）

### spatialPartitioning
- **作用**：空间分区配置
- **分区策略**：
  - 网格分区：将画布分成网格
  - 四叉树分区：动态分区
  - 简单分区：基础分区
- **默认值**：网格分区
- **影响点**：大量拼图块时的检测效率
- **配置/代码位置**：碰撞检测优化逻辑

### collisionCache
- **作用**：碰撞检测缓存配置
- **缓存策略**：
  - 缓存检测结果
  - 智能缓存失效
  - 内存使用控制
- **缓存时间**：100ms
- **默认值**：启用智能缓存
- **影响点**：重复检测的性能
- **配置/代码位置**：碰撞检测缓存逻辑

---

## 6. 设备适配配置

### mobileCollisionOptimization
- **作用**：移动端碰撞优化配置
- **优化策略**：
  - 降低检测精度，提升性能
  - 增加碰撞容忍度
  - 优化触摸响应
- **优化参数**：
  - 检测阈值：0.2px（vs 桌面端0.1px）
  - 回弹强度：0.3（vs 桌面端0.4）
  - 震动强度：减弱20%
- **默认值**：移动端自动启用
- **影响点**：移动端性能和体验平衡
- **配置/代码位置**：`contexts/GameContext.tsx`（移动端优化）

### touchCollisionHandling
- **作用**：触摸碰撞处理配置
- **处理策略**：
  - 触摸拖拽时的碰撞处理
  - 触摸释放时的回弹处理
  - 多点触摸的碰撞协调
- **默认值**：启用触摸碰撞处理
- **影响点**：触摸操作的流畅性
- **配置/代码位置**：`hooks/usePuzzleInteractions.ts`（触摸处理）

### devicePerformanceScaling
- **作用**：设备性能缩放配置
- **缩放策略**：
  - 低端设备：简化碰撞检测
  - 高端设备：提高检测精度
  - 自动检测设备性能
- **默认值**：启用性能缩放
- **影响点**：不同设备的性能适配
- **配置/代码位置**：设备性能检测逻辑

---

## 7. 碰撞类型配置

### boundaryCollision
- **作用**：边界碰撞配置
- **边界类型**：
  - 上边界：顶部碰撞
  - 下边界：底部碰撞
  - 左边界：左侧碰撞
  - 右边界：右侧碰撞
- **处理策略**：每种边界独立处理
- **默认值**：启用所有边界碰撞
- **影响点**：边界碰撞的完整性
- **配置/代码位置**：`contexts/GameContext.tsx`（边界处理）

### cornerCollision
- **作用**：角落碰撞配置
- **角落处理**：
  - 双边界同时碰撞
  - 对角回弹计算
  - 特殊音效处理
- **默认值**：启用角落碰撞处理
- **影响点**：角落碰撞的特殊处理
- **配置/代码位置**：`contexts/GameContext.tsx`（角落处理逻辑）

### pieceCollision
- **作用**：拼图块间碰撞配置
- **碰撞处理**：
  - 拼图块间的相互碰撞
  - 碰撞后的位置调整
  - 碰撞音效和动画
- **默认值**：启用拼图块间碰撞
- **影响点**：拼图块交互的真实感
- **配置/代码位置**：拼图块碰撞逻辑

---

## 8. 回弹物理配置

### physicsEngine
- **作用**：物理引擎配置
- **物理参数**：
  - 重力：0（无重力）
  - 摩擦力：0.1
  - 弹性系数：0.4
  - 阻尼系数：0.8
- **默认值**：如上所示
- **影响点**：回弹的物理真实感
- **配置/代码位置**：`contexts/GameContext.tsx`（物理计算）

### velocityCalculation
- **作用**：速度计算配置
- **计算方法**：
  - 基于拖拽距离计算初始速度
  - 考虑拖拽时间的速度衰减
  - 碰撞后的速度变化
- **默认值**：启用速度计算
- **影响点**：回弹效果的真实性
- **配置/代码位置**：`contexts/GameContext.tsx`（速度计算）

### energyConservation
- **作用**：能量守恒配置
- **守恒策略**：
  - 碰撞前后动能计算
  - 能量损失模拟
  - 多次碰撞的能量衰减
- **默认值**：启用能量守恒
- **影响点**：物理效果的合理性
- **配置/代码位置**：物理引擎逻辑

---

## 9. 调试配置

### collisionDebugMode
- **作用**：碰撞调试模式配置
- **调试功能**：
  - 显示碰撞检测区域
  - 输出碰撞计算详情
  - 验证回弹效果
- **默认值**：开发环境启用，生产环境禁用
- **影响点**：开发调试效率
- **配置/代码位置**：`contexts/GameContext.tsx`（调试日志）

### collisionVisualization
- **作用**：碰撞可视化配置
- **可视化内容**：
  - 碰撞点标记
  - 回弹轨迹显示
  - 速度向量显示
- **默认值**：调试模式下启用
- **影响点**：碰撞分析和优化
- **配置/代码位置**：碰撞可视化逻辑

### performanceMonitoring
- **作用**：碰撞性能监控配置
- **监控指标**：
  - 碰撞检测时间
  - 回弹计算时间
  - 内存使用情况
- **默认值**：开发环境启用
- **影响点**：性能分析和优化
- **配置/代码位置**：性能监控逻辑

---

## 10. 配置示例

### 基础碰撞配置示例
```typescript
// 碰撞回弹配置
const collisionConfig = {
  detection: {
    threshold: 0.1,
    method: 'boundingBox',
    optimization: true
  },
  bounce: {
    factor: 0.4,
    maxDistance: 60,
    animation: true
  },
  sound: {
    enabled: true,
    lowFreq: 120,
    highFreq: 240,
    volume: 0.2
  }
};
```

### 震动动画配置示例
```typescript
// 震动动画配置
const shakeConfig = {
  animation: {
    count: 6,
    amplitude: [8, -6, 5, -4, 3, -2],
    interval: 30,
    duration: 180
  },
  intensity: 'medium',
  direction: 'auto',
  easing: 'decay'
};
```

### 设备适配配置示例
```typescript
// 设备特定碰撞配置
const deviceCollisionConfig = {
  mobile: {
    detection: { threshold: 0.2 },
    bounce: { factor: 0.3 },
    shake: { intensity: 'light' },
    optimization: true
  },
  desktop: {
    detection: { threshold: 0.1 },
    bounce: { factor: 0.4 },
    shake: { intensity: 'medium' },
    optimization: false
  }
};
```

---

## 11. 故障排除

### 常见问题
1. **回弹效果不明显**：检查回弹强度和距离配置
2. **碰撞检测不准确**：调整检测阈值和方法配置
3. **震动动画卡顿**：确认动画优化配置已启用
4. **音效不播放**：验证音效触发条件和全局开关

### 调试方法
- 启用碰撞调试模式
- 检查碰撞检测参数
- 验证回弹计算逻辑
- 监控碰撞性能指标

---

> 📖 **相关文档**
> - [拼图散开与分布配置](./08-puzzle-scatter.md)
> - [旋转配置](./10-rotation.md)
> - [触摸事件与交互配置](./18-touch-interaction.md)