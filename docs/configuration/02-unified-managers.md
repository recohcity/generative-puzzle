# ç»Ÿä¸€æ¶æ„ç®¡ç†å™¨é…ç½® (v1.3.33)

> ä¿®è®¢æ—¥æœŸï¼š2025-01-24 (v1.3.33 æ–°å¢)

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜v1.3.33ç‰ˆæœ¬ä¸­æ–°å¢çš„ç»Ÿä¸€æ¶æ„ç®¡ç†å™¨é…ç½®ï¼ŒåŒ…æ‹¬DeviceManagerã€CanvasManagerã€EventManagerã€AdaptationEngineå››å¤§æ ¸å¿ƒç®¡ç†å™¨çš„é…ç½®å‚æ•°ã€‚

---

## 1. DeviceManager é…ç½®

### singleton
- **ä½œç”¨**ï¼šå•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€çš„è®¾å¤‡æ£€æµ‹å®ä¾‹
- **å–å€¼èŒƒå›´**ï¼šDeviceManager.getInstance()
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨åˆ›å»ºå•ä¾‹
- **å½±å“ç‚¹**ï¼šè®¾å¤‡æ£€æµ‹ä¸€è‡´æ€§ã€å†…å­˜ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/DeviceManager.ts`

### deviceDetectionCache
- **ä½œç”¨**ï¼šè®¾å¤‡æ£€æµ‹ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **å–å€¼èŒƒå›´**ï¼š{ isMobile: boolean, isPortrait: boolean, deviceType: string }
- **é»˜è®¤å€¼**ï¼šé¦–æ¬¡æ£€æµ‹æ—¶è‡ªåŠ¨ç¼“å­˜
- **å½±å“ç‚¹**ï¼šæ€§èƒ½ä¼˜åŒ–ã€æ£€æµ‹ä¸€è‡´æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/DeviceManager.ts`

### deviceDetectionMethods
- **ä½œç”¨**ï¼šè®¾å¤‡æ£€æµ‹æ–¹æ³•ä¼˜å…ˆçº§é…ç½®
- **å–å€¼èŒƒå›´**ï¼šç”¨æˆ·ä»£ç†æ£€æµ‹ â†’ å±å¹•å°ºå¯¸æ£€æµ‹ â†’ è§¦æ‘¸æ£€æµ‹
- **é»˜è®¤å€¼**ï¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œ
- **å½±å“ç‚¹**ï¼šè®¾å¤‡è¯†åˆ«å‡†ç¡®æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/DeviceManager.ts`

---

## 2. CanvasManager é…ç½®

### singleton
- **ä½œç”¨**ï¼šå•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€çš„ç”»å¸ƒç®¡ç†å®ä¾‹
- **å–å€¼èŒƒå›´**ï¼šCanvasManager.getInstance()
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨åˆ›å»ºå•ä¾‹
- **å½±å“ç‚¹**ï¼šç”»å¸ƒçŠ¶æ€ä¸€è‡´æ€§ã€å†…å­˜ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/CanvasManager.ts`

### canvasStateCache
- **ä½œç”¨**ï¼šç”»å¸ƒçŠ¶æ€ç¼“å­˜ï¼Œç»Ÿä¸€ç®¡ç†ç”»å¸ƒå°ºå¯¸ã€ç¼©æ”¾ç­‰çŠ¶æ€
- **å–å€¼èŒƒå›´**ï¼š{ size: CanvasSize, scale: number, orientation: string }
- **é»˜è®¤å€¼**ï¼šåˆå§‹åŒ–æ—¶è‡ªåŠ¨è®¾ç½®
- **å½±å“ç‚¹**ï¼šç”»å¸ƒé€‚é…ã€çŠ¶æ€åŒæ­¥
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/CanvasManager.ts`

### canvasSizeCalculation
- **ä½œç”¨**ï¼šç”»å¸ƒå°ºå¯¸è®¡ç®—ç­–ç•¥é…ç½®
- **å–å€¼èŒƒå›´**ï¼šåŠ¨æ€è®¡ç®—ç­–ç•¥ï¼Œæ ¹æ®è®¾å¤‡ç±»å‹é€‰æ‹©ä¸åŒç®—æ³•
- **é»˜è®¤å€¼**ï¼šè‡ªé€‚åº”è®¡ç®—
- **å½±å“ç‚¹**ï¼šç”»å¸ƒæ˜¾ç¤ºæ•ˆæœã€é€‚é…è´¨é‡
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/CanvasManager.ts`

---

## 3. EventManager é…ç½®

### singleton
- **ä½œç”¨**ï¼šå•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€çš„äº‹ä»¶ç®¡ç†å®ä¾‹
- **å–å€¼èŒƒå›´**ï¼šEventManager.getInstance()
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨åˆ›å»ºå•ä¾‹
- **å½±å“ç‚¹**ï¼šäº‹ä»¶ç›‘å¬å™¨ç®¡ç†ã€å†…å­˜ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/EventManager.ts`

### eventListenerRegistry
- **ä½œç”¨**ï¼šäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œè¡¨ï¼Œé¿å…é‡å¤ç›‘å¬
- **å–å€¼èŒƒå›´**ï¼šMap<string, EventListener[]>
- **é»˜è®¤å€¼**ï¼šç©ºMapï¼ŒåŠ¨æ€æ³¨å†Œ
- **å½±å“ç‚¹**ï¼šäº‹ä»¶ç›‘å¬å™¨ä¼˜åŒ–ã€å†…å­˜æ³„æ¼é˜²æŠ¤
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/EventManager.ts`

### maxListenersPerEvent
- **ä½œç”¨**ï¼šæ¯ä¸ªäº‹ä»¶ç±»å‹çš„æœ€å¤§ç›‘å¬å™¨æ•°é‡é™åˆ¶
- **å–å€¼èŒƒå›´**ï¼š1~10
- **é»˜è®¤å€¼**ï¼š3
- **å½±å“ç‚¹**ï¼šæ€§èƒ½ä¼˜åŒ–ã€å†…å­˜æ§åˆ¶
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/EventManager.ts`

### eventTypes
- **ä½œç”¨**ï¼šæ”¯æŒçš„äº‹ä»¶ç±»å‹é…ç½®
- **å–å€¼èŒƒå›´**ï¼šresize, orientationchange, visibilitychange
- **é»˜è®¤å€¼**ï¼šå…¨éƒ¨å¯ç”¨
- **å½±å“ç‚¹**ï¼šäº‹ä»¶ç›‘å¬èŒƒå›´ã€æ€§èƒ½ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/EventManager.ts`

---

## 4. AdaptationEngine é…ç½®

### singleton
- **ä½œç”¨**ï¼šå•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€çš„é€‚é…å¼•æ“å®ä¾‹
- **å–å€¼èŒƒå›´**ï¼šAdaptationEngine.getInstance()
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨åˆ›å»ºå•ä¾‹
- **å½±å“ç‚¹**ï¼šé€‚é…é€»è¾‘ç»Ÿä¸€ã€æ€§èƒ½ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/AdaptationEngine.ts`

### adaptationQueue
- **ä½œç”¨**ï¼šé€‚é…ä»»åŠ¡é˜Ÿåˆ—ï¼Œé¿å…å¹¶å‘é€‚é…å†²çª
- **å–å€¼èŒƒå›´**ï¼šQueue<AdaptationTask>
- **é»˜è®¤å€¼**ï¼šç©ºé˜Ÿåˆ—ï¼ŒåŠ¨æ€æ·»åŠ ä»»åŠ¡
- **å½±å“ç‚¹**ï¼šé€‚é…æ€§èƒ½ã€çŠ¶æ€ä¸€è‡´æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/AdaptationEngine.ts`

### adaptationStrategies
- **ä½œç”¨**ï¼šé€‚é…ç­–ç•¥é…ç½®ï¼Œæ”¯æŒä¸åŒç±»å‹çš„é€‚é…ç®—æ³•
- **å–å€¼èŒƒå›´**ï¼šå½¢çŠ¶é€‚é…ã€æ‹¼å›¾å—é€‚é…ã€æ•£å¼€æ‹¼å›¾é€‚é…
- **é»˜è®¤å€¼**ï¼šå…¨éƒ¨å¯ç”¨
- **å½±å“ç‚¹**ï¼šé€‚é…åŠŸèƒ½å®Œæ•´æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/AdaptationEngine.ts`

---

## 5. ç»Ÿä¸€æ¶æ„Hooksé…ç½®

### useDevice Hook
- **ä½œç”¨**ï¼šç»Ÿä¸€è®¾å¤‡æ£€æµ‹Hookï¼Œæ›¿ä»£åˆ†æ•£çš„è®¾å¤‡æ£€æµ‹é€»è¾‘
- **å–å€¼èŒƒå›´**ï¼š{ isMobile: boolean, isPortrait: boolean, deviceType: string }
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨æ£€æµ‹
- **å½±å“ç‚¹**ï¼šæ‰€æœ‰ç»„ä»¶çš„è®¾å¤‡æ£€æµ‹é€»è¾‘
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`hooks/useDevice.ts`

### useCanvas Hook
- **ä½œç”¨**ï¼šç»Ÿä¸€ç”»å¸ƒç®¡ç†Hookï¼Œæ›¿ä»£åˆ†æ•£çš„ç”»å¸ƒçŠ¶æ€ç®¡ç†
- **å–å€¼èŒƒå›´**ï¼š{ canvasSize: CanvasSize, scale: number, updateCanvas: Function }
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨åˆå§‹åŒ–
- **å½±å“ç‚¹**ï¼šæ‰€æœ‰å¸ƒå±€ç»„ä»¶çš„ç”»å¸ƒç®¡ç†
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`hooks/useCanvas.ts`

### useEventManager Hook
- **ä½œç”¨**ï¼šç»Ÿä¸€äº‹ä»¶ç®¡ç†Hookï¼Œæ›¿ä»£åˆ†æ•£çš„äº‹ä»¶ç›‘å¬å™¨
- **å–å€¼èŒƒå›´**ï¼š{ addEventListener: Function, removeEventListener: Function }
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨ç®¡ç†
- **å½±å“ç‚¹**ï¼šäº‹ä»¶ç›‘å¬å™¨æ•°é‡å‡å°‘85%
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`hooks/useEventManager.ts`

---

## 6. æ€§èƒ½ä¼˜åŒ–é…ç½®

### managerInitTime
- **ä½œç”¨**ï¼šç®¡ç†å™¨åˆå§‹åŒ–æ—¶é—´åŸºå‡†
- **å–å€¼èŒƒå›´**ï¼š<10ms
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨æµ‹é‡
- **å½±å“ç‚¹**ï¼šå¯åŠ¨æ€§èƒ½
- **é…ç½®/ä»£ç ä½ç½®**ï¼šå„ç®¡ç†å™¨æ„é€ å‡½æ•°

### eventListenerReduction
- **ä½œç”¨**ï¼šäº‹ä»¶ç›‘å¬å™¨æ•°é‡å‡å°‘æ¯”ä¾‹
- **å–å€¼èŒƒå›´**ï¼š85%å‡å°‘ï¼ˆä»~20ä¸ªåˆ°3ä¸ªï¼‰
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨ç»Ÿè®¡
- **å½±å“ç‚¹**ï¼šå†…å­˜ä½¿ç”¨ã€æ€§èƒ½ä¼˜åŒ–
- **é…ç½®/ä»£ç ä½ç½®**ï¼š`utils/core/EventManager.ts`

### codeReductionRatio
- **ä½œç”¨**ï¼šä»£ç é‡å¤åº¦å‡å°‘æ¯”ä¾‹
- **å–å€¼èŒƒå›´**ï¼š70%å‡å°‘
- **é»˜è®¤å€¼**ï¼šé‡æ„åè‡ªåŠ¨è¾¾æˆ
- **å½±å“ç‚¹**ï¼šç»´æŠ¤æ€§ã€å¯è¯»æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼šå…¨å±€é‡æ„æˆæœ

### memoryOptimization
- **ä½œç”¨**ï¼šå†…å­˜ä½¿ç”¨ä¼˜åŒ–é…ç½®
- **å–å€¼èŒƒå›´**ï¼šå•ä¾‹æ¨¡å¼ + ç¼“å­˜æœºåˆ¶ + äº‹ä»¶ç›‘å¬å™¨ä¼˜åŒ–
- **é»˜è®¤å€¼**ï¼šå…¨éƒ¨å¯ç”¨
- **å½±å“ç‚¹**ï¼šå†…å­˜ä½¿ç”¨ç¨³å®šæ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼šå„ç®¡ç†å™¨å®ç°

---

## 7. ç»„ä»¶è¿ç§»é…ç½®

### migratedComponents
- **ä½œç”¨**ï¼šå·²è¿ç§»åˆ°ç»Ÿä¸€æ¶æ„çš„ç»„ä»¶åˆ—è¡¨
- **ç»„ä»¶åˆ—è¡¨**ï¼š
  - æ‰€æœ‰æ§åˆ¶ç»„ä»¶ï¼šActionButtonsã€ShapeControlsã€PuzzleControlsç³»åˆ—
  - æ‰€æœ‰å¸ƒå±€ç»„ä»¶ï¼šDesktopLayoutã€PhoneLandscapeLayoutã€PhonePortraitLayout
  - èƒŒæ™¯ç»„ä»¶ï¼šResponsiveBackground
  - æ ¸å¿ƒç»„ä»¶ï¼šPuzzleCanvas
- **å½±å“ç‚¹**ï¼šä»£ç é‡å¤åº¦é™ä½70%ï¼Œäº‹ä»¶ç›‘å¬å™¨å‡å°‘85%
- **é…ç½®/ä»£ç ä½ç½®**ï¼šå„ç»„ä»¶æ–‡ä»¶ï¼ˆä½¿ç”¨useDevice()ã€useCanvas()ã€useEventManager()ï¼‰

### migrationStatus
- **ä½œç”¨**ï¼šç»„ä»¶è¿ç§»çŠ¶æ€è·Ÿè¸ª
- **å–å€¼èŒƒå›´**ï¼š95%å®Œæˆ
- **é»˜è®¤å€¼**ï¼šè‡ªåŠ¨ç»Ÿè®¡
- **å½±å“ç‚¹**ï¼šé‡æ„è´¨é‡è¯„ä¼°
- **é…ç½®/ä»£ç ä½ç½®**ï¼šé‡æ„æ€»ç»“æ–‡æ¡£

---

## 8. å…¼å®¹æ€§é…ç½®

### backwardCompatibility
- **ä½œç”¨**ï¼šä¸ä¼ ç»Ÿç³»ç»Ÿçš„å‘åå…¼å®¹æ€§ä¿è¯
- **å…¼å®¹ç­–ç•¥**ï¼šä¿ç•™åŸæœ‰Hookæ¥å£ï¼Œé€æ­¥è¿ç§»
- **é»˜è®¤å€¼**ï¼šå¯ç”¨å…¼å®¹æ€§ä¿è¯
- **å½±å“ç‚¹**ï¼šç³»ç»Ÿå‡çº§çš„å¹³æ»‘æ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼šå„Hookæ–‡ä»¶çš„å…¼å®¹æ€§å¤„ç†

### legacyHookSupport
- **ä½œç”¨**ï¼šä¼ ç»ŸHookçš„æ”¯æŒé…ç½®
- **æ”¯æŒèŒƒå›´**ï¼šuseDeviceDetectionã€useResponsiveCanvasSizingç­‰
- **é»˜è®¤å€¼**ï¼šä¿æŒæ”¯æŒï¼Œé€æ­¥è¿ç§»
- **å½±å“ç‚¹**ï¼šè¿ç§»è¿‡ç¨‹çš„ç¨³å®šæ€§
- **é…ç½®/ä»£ç ä½ç½®**ï¼šä¼ ç»ŸHookæ–‡ä»¶

---

## 9. é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹
```typescript
// ä½¿ç”¨ç»Ÿä¸€æ¶æ„çš„ç»„ä»¶ç¤ºä¾‹
import { useDevice } from '@/hooks/useDevice';
import { useCanvas } from '@/hooks/useCanvas';
import { useEventManager } from '@/hooks/useEventManager';

export function ExampleComponent() {
  // ç»Ÿä¸€è®¾å¤‡æ£€æµ‹
  const { isMobile, isPortrait, deviceType } = useDevice();
  
  // ç»Ÿä¸€ç”»å¸ƒç®¡ç†
  const { canvasSize, scale, updateCanvas } = useCanvas();
  
  // ç»Ÿä¸€äº‹ä»¶ç®¡ç†
  const { addEventListener, removeEventListener } = useEventManager();
  
  // ç»„ä»¶é€»è¾‘...
}
```

---

## 10. æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥**ï¼šæ£€æŸ¥å•ä¾‹æ¨¡å¼å®ç°
2. **äº‹ä»¶ç›‘å¬å™¨é‡å¤**ï¼šç¡®è®¤ä½¿ç”¨ç»Ÿä¸€äº‹ä»¶ç®¡ç†å™¨
3. **è®¾å¤‡æ£€æµ‹ä¸å‡†ç¡®**ï¼šæ£€æŸ¥è®¾å¤‡æ£€æµ‹ä¼˜å…ˆçº§é…ç½®
4. **ç”»å¸ƒçŠ¶æ€ä¸åŒæ­¥**ï¼šç¡®è®¤ä½¿ç”¨ç»Ÿä¸€ç”»å¸ƒç®¡ç†å™¨

### è°ƒè¯•æ–¹æ³•
- æ£€æŸ¥ç®¡ç†å™¨å•ä¾‹çŠ¶æ€
- ç›‘æ§äº‹ä»¶ç›‘å¬å™¨æ•°é‡
- éªŒè¯è®¾å¤‡æ£€æµ‹ç»“æœ
- è¿½è¸ªç”»å¸ƒçŠ¶æ€å˜åŒ–

---

> ğŸ“– **ç›¸å…³æ–‡æ¡£**
> - [æ ¸å¿ƒæ¶æ„é…ç½®](./01-core-architecture.md)
> - [ç§»åŠ¨ç«¯é€‚é…é…ç½®](./03-mobile-adaptation.md)
> - [é‡æ„æ–‡æ¡£](../rebuild/REFACTORING_SUMMARY.md)